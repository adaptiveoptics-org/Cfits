<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>cfitsTK: PIAACMCsimul</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">cfitsTK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_src_PIAACMCsimul_doc_PIAACMCsimul.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PIAACMCsimul </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>% PIAACMC design % Olivier Guyon % 2015-present</p>
<h1>Overview</h1>
<h2>Scope</h2>
<p>Diffraction-based PIAACMC simulation / optimization</p>
<ul>
<li>Uses Fresnel propagation engine ( <a class="el" href="OptSystProp_8c.html" title="Optical system propagation. ">OptSystProp.c</a> <a class="el" href="OptSystProp_8h.html">OptSystProp.h</a> ) between optical elements</li>
<li>Computes linear perturbations around current design for optimization</li>
<li>Automatically computes multiple Lyot stop to follow variable conjugation in different parts of the beam</li>
<li>Polychromatic propagations</li>
<li>Fits aspheric PIAA shapes on basis of radial cosines and 2-D Fourier modes</li>
</ul>
<h2>Usage</h2>
<p>Scripts to run the software are located within the source code directory: </p><pre class="fragment">./src/PIAACMCsimul/scripts/
</pre><p>The scripts can be linked to your working directory by executing the following command: </p><pre class="fragment">ln -s $PWD/syncscripts /myworkdirectory/syncscripts
</pre><p>Then, execute in your work directory: </p><pre class="fragment">./syncscripts
</pre><p>This will install all required scripts in workdirectory and install any packages required.</p>
<p>Code is composed of a several layers (from high to low) :</p>
<hr/>
<p> Script Description </p><hr/>
<p> <b>runPIAACMCdesign</b> Top level script ("-h" for help)</p>
<p><b>run</b> Main script, calls <b>runopt</b> script</p>
<p><b>runopt</b> Optimize a PIAACMC design or run an existing design calls <b>sim</b> script</p>
<p><b>sim</b> calls <b>runPIAACMC</b> script</p>
<p><b>runPIAACMC</b> lower-level script calling C-written executable </p><hr/>
<div class="image">
<img src="figures/scripts_flow.jpg"  alt="scripts"/>
</div>
<p><a href="PIAACMCsimul_script_run.html">Detailed description of script run</a> <a href="PIAACMCsimul_script_runopt.html">Detailed description of script runopt</a> <a href="PIAACMCsimul_script_sim.html">Detailed description of script sim</a> <a href="PIAACMCsimul_script_runPIAACMC.html">Detailed description of script runPIAACMC</a></p>
<h1>Quick start</h1>
<h2>Configuration Setup</h2>
<p>Print help for top level script: </p><pre class="fragment">./runPIAACMCdesign -h
</pre><p>The quickest way to get started is to setup and modify one of the example design scripts provided: </p><pre class="fragment">./runPIAACMCdesign -e 0
</pre><p>This will configure all necessary files for a specific configuration. You can view parameters with : </p><pre class="fragment">./runPIAACMCdesign -l
</pre><p>If optimizing in APLC mode (no PIAA optics), type (after the -e command above): </p><pre class="fragment">./runPIAACMCdesign -a
</pre><h2>Design</h2>
<p>Design is done with the "-m" option. This command will execute all design steps from 0 to #step-1: </p><pre class="fragment">./runPIAACMCdesign -m &lt;#step&gt;
</pre><p>Individual design steps are described below.</p>
<p>To run the full polychromatic design process: </p><pre class="fragment">./runPIAACMCdesign -m 200
</pre><p>Note that this may take a long time to run ... (days ?). The polychromatic design will:</p>
<ul>
<li>Construct response to focal plane mask zones if it does not already exist. This step runs in tmux sessions, and will write a FPMresp...fits file</li>
<li>Execute a search for best solution.</li>
</ul>
<h1>Design steps: Monochromatic design ( #step &lt; 100 )</h1>
<h2>Overview</h2>
<p>The design proceeds in discrete steps. The example scripts show the individual steps, and each step is executed with a separate command line.</p>
<p>Steps from 0 to 99 are executed sequentially to design a monochromatic PIAACMC. For these steps, the user may run multiple steps with a single command. For example, running step 18 will execute all steps from 0 to 17 included. If a step has already been completed, it will not be re-run.</p>
<p>The monochromatic PIAACMC design process is as follows:</p>
<ul>
<li>design an idealized monochromatic PIAACMC for a centrally obscured aperture (steps 1-4)</li>
<li>modify the design for the pupil aperture (steps 5-)</li>
</ul>
<h2>STEP 000 (MODE=0): Create an idealized centrally obscured apodized PIAACMC monochromatic design</h2>
<p>This is meant as a starting point for the PIAACMC, which will then be optimized further. This step takes a few minutes, and upon normal completion, display:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./runPIAACMC REACHED STATE EXIT POINT (1)</div>
</div><!-- fragment --><p>The prolate function for a centrally obscured pupili is created, along with the idealized focal plane mask. The diffraction propagation code then computes complex amplitude in each plane.</p>
<p>This step takes a few minutes - most of the time is spent on iterations to compute the 2D apodization prolate function, executing discrete Fourier transforms (DFTs).</p>
<p>After this step, the contrast will likely be around 1e-7 to 1e-8. The next step to improve this nominal design is to find the optimal locations for the Lyot stops.</p>
<hr/>
<p> Output file Description </p><hr/>
<p> Cmodes_1024.fits Cosine modes applied for PIAA optics shapes optimization</p>
<p>Fmodes_1024.fits Fourier modes applied for PIAA optics shapes optimization</p>
<p>piaacmcconf_i000/WFamp0_xxx.fits Amplitude in plane xxx</p>
<p>piaacmcconf_i000/WFpha0_xxx.fits Phase in plane xxx</p>
<p>piaacmcconf_i000/conjugations.txt List of planes and conjugation distance to reference</p>
<p>piaacmcconf_i000/apo2Drad.fits Amplitude apodization (entirely allocated to PIAA optics)</p>
<p>piaacmcconf_i000/PIAA_Mshapes.txt aspheric optics shapes (r0 z0 r1 z1), unit [m]</p>
<p>piaacmcconf_i000/piaam0z.fits first PIAA mirror sag [m]</p>
<p>piaacmcconf_i000/piaam1z.fits second PIAA mirror sag [m]</p>
<p>piaacmcconf_i000/psfi0_step000.fits Coronagraphic PSF (flux normalized to total=1 without coronagraph) </p><hr/>
<p>The conjugations.txt file should contain number, location and description of each plane:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;00  0.000000    input pupil</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;01  0.000000    TT mirror</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;02  -1.102609   pupil plane apodizer</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;03  1.199997    PIAA optics 0</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;04  -1.102609   PIAA optics 1</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;05  -1.102609   opaque mask at PIAA elem 1</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;06  -1.102609   post focal plane mask pupil</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;07  0.000000    Lyot mask 0</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;08  0.000000    back end pupil stop  (rad = 0.920000)</div>
</div><!-- fragment --><p>The complex amplitude for each of these planes (files WFamp0_xxx.fits) should show the pupil apodization and coronagraphic effect induced by the focal plane mask which moves light into the central obstruction.</p>
<div class="image">
<img src="figures/examplePIAA_step0_WFamp.png"  alt="Amplitude in each of the 9 planes"/>
</div>
<p>The script provides some approximate performance metrics upon normal exit:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;saved -&gt; test_psfc0a.fits</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   0    114332.0000 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   1    114332.0000 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   2    114331.9875 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   3    114331.9736 1.000000</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   4    114331.9445 1.000000</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   5    114331.8632 0.999999</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   6     36330.5968 0.317764</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    FLUX   7       552.3991 0.004832</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    FLUX   8        95.3810 0.000834</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;Peak constrast (rough estimate)= 3617.04 -&gt; 2.76706e-07</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;optsyst[0].flux[0]  = 114332</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;[0] Total light in scoring field = 1.32039e+06, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 4.14658e-08</div>
</div><!-- fragment --><h2>STEP 001: Propagate solution and compute PSF</h2>
<p>The previous solution is propagated. This should yield the same result as step 0. This should take approximately 1mn.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    114332.0000 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    114332.0000 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    114331.9848 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    114331.9558 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    114331.9316 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5     36329.5003 0.317754</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       542.4649 0.004745</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7        96.0420 0.000840</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 3025.69 -&gt; 2.31467e-07</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 114332</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 1.3261e+06, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 4.1645e-08</div>
</div><!-- fragment --><h2>STEP 002: Specify input pupil geometry</h2>
<p>The pupil geometry is copied to file <code>piaacmcconf_i000/pupa0_1024.fits</code></p>
<h2>STEP 003 (mode = 0): compute on-axis PSF for new pupil geometry</h2>
<p>Same as step 1, but taking into account the pupil geometry. With spiders or gaps in the pupil, the contrast will not be as good</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7614 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.7012 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    155983.4386 0.374794</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6     32825.0378 0.078871</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7     30509.7138 0.073308</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 2.74249e+07 -&gt; 0.000158334</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 7.35517e+09, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 1.74319e-05</div>
</div><!-- fragment --><p>This step should take approximately 1mn.</p>
<h2>STEP 004 (mode = 5): Compute Lyot stops shapes and locations, 1st pass</h2>
<p>For circular centrally obscured pupils, the default Lyot stops configuration consists of two stops: one that masks the outer part of the beam, and one that masks the central obstruction.</p>
<p>Fine optimization of the stops locations is done with a separate command. The optional lsoptrange value is the range (unit: m) for the mask position search.</p>
<p>When the optimization completes, the best solutions are listed:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;BEST SOLUTION: 0.000000000000 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.706241153417  0.019795686221</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;BEST SOLUTION: 6.695657648611 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.706237596354  0.019795151562</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;BEST SOLUTION: 7.365223413472 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.706219734865  0.019792653140</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;BEST SOLUTION: 8.034789178333 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.706026161578  0.019768034052</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;BEST SOLUTION: 8.704354943194 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.705220276320  0.019673042636</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;BEST SOLUTION: 9.373920708056 / 33.478288243056    0.000000556868 / 0.000044544711  -&gt; 0.702039509211  0.019321456405</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;BEST SOLUTION: 32.808722478194 / 33.478288243056    0.000000668241 / 0.000044544711  -&gt; 0.733651721375  0.019318291526</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;BEST SOLUTION: 33.478288243056 / 33.478288243056    0.000000668241 / 0.000044544711  -&gt; 0.710514365016  0.018620791690</div>
</div><!-- fragment --><p>The optimal Lyot stop(s) conjugation(s) is written in file <code>piaacmcparams_step004.conf</code></p>
<p>This step takes about 2hr.</p>
<h2>STEP 005 (mode = 2): Optimize focal plane mask transmission, 1st pass</h2>
<p>Optimizes the focal plane mask transmission. Results are written in file <code>result_fpmt.log</code></p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;0.031579 1.35944e-05  0 0.3 0.1</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;0.131579 7.96891e-06  0 0.3 0.1</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;0.231579 3.83775e-06  0 0.3 0.1</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;0.331579 1.20092e-06  0 0.3 0.1</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;0.431579 5.84203e-08  0 0.3 0.1</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;0.531579 4.10247e-07  0 0.3 0.1</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;0.631579 2.2564e-06  0 0.3 0.1</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;0.341579 1.01943e-06  1 0.09 0.03</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;0.371579 5.64602e-07  1 0.09 0.03</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;0.401579 2.44266e-07  1 0.09 0.03</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;0.431579 5.84203e-08  1 0.09 0.03</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;0.461579 7.06368e-09  1 0.09 0.03</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;0.491579 9.01969e-08  1 0.09 0.03</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;0.521579 3.0782e-07  1 0.09 0.03</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;0.434579 4.72326e-08  2 0.027 0.009</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;0.443579 2.1739e-08  2 0.027 0.009</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;0.452579 8.34926e-09  2 0.027 0.009</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;0.461579 7.06368e-09  2 0.027 0.009</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;0.470579 1.78822e-08  2 0.027 0.009</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;0.479579 4.08046e-08  2 0.027 0.009</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;0.488579 7.58315e-08  2 0.027 0.009</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;0.453479 7.676e-09  3 0.0081 0.0027</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;0.456179 6.38254e-09  3 0.0081 0.0027</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;0.458879 6.17844e-09  3 0.0081 0.0027</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;0.461579 7.06368e-09  3 0.0081 0.0027</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;0.464279 9.03836e-09  3 0.0081 0.0027</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;0.466979 1.21023e-08  3 0.0081 0.0027</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;0.469679 1.62556e-08  3 0.0081 0.0027</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;0.456449 6.31312e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;0.457259 6.17018e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;0.458069 6.12529e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;0.458879 6.17844e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;0.459689 6.32964e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;0.460499 6.57888e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;0.461309 6.92612e-09  4 0.00243 0.00081</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;0.457340 6.16129e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;0.457583 6.14047e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;0.457826 6.12846e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;0.458069 6.12529e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;0.458312 6.13094e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;0.458555 6.14542e-09  5 0.000729 0.000243</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;0.458798 6.16872e-09  5 0.000729 0.000243</div>
</div><!-- fragment --><p>This takes about 30mn</p>
<h2>STEP 006 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
<p>Takes about 10mn</p>
<h2>STEP 007 (mode = 40): Tune PIAA shapes and focal plane mask transm, 10 cosine modes, 5 Fourier modes</h2>
<p>This takes approximately 20mn for size = 1024.</p>
<p>Progress can be tracked by watching file :</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;tail -f linoptval.txt</div>
</div><!-- fragment --><h2>STEP 008 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7608 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.6991 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    189642.2892 0.455669</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       216.7150 0.000521</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7       216.7150 0.000521</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 6272.06 -&gt; 3.62109e-08</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 291196, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 6.90139e-10</div>
</div><!-- fragment --><p>This step takes 3 hr</p>
<h2>STEP 009 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
<p>This step takes approximately 4mn.</p>
<h2>STEP 010 (mode = 1): Tune Lyot stops conjugations</h2>
<p>To view result:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;tail -f result_LMpos.log</div>
</div><!-- fragment --><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7608 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.6991 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    189690.4898 0.455785</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       159.9713 0.000384</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7       159.9713 0.000384</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 7922.02 -&gt; 4.57368e-08</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 298404, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 7.07224e-10</div>
</div><!-- fragment --><p>This step takes approximately 5mn.</p>
<h2>STEP 011 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7605 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.6985 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    192668.7345 0.462941</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       159.3355 0.000383</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7       159.3355 0.000383</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 8636.87 -&gt; 4.98638e-08</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 209897, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 4.97461e-10</div>
</div><!-- fragment --><h2>STEP 012 (mode = 40): Tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;The total number of free parameters is 380 = (40+150)*2, so this routine takes a long time to complete (hours).</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   3    416183.7615 1.000000</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   4    416183.6991 0.999999</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   5    193239.3033 0.464312</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   6       159.4789 0.000383</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    FLUX   7       159.4789 0.000383</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Peak constrast (rough estimate)= 306.006 -&gt; 1.76669e-09</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;[0] Total light in scoring field = 29496.3, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 6.99069e-11</div>
</div><!-- fragment --><p>takes 4hr</p>
<h2>STEP 013 (mode = 5): Compute Lyot stops shapes and locations, 3nd pass, 70% throughput</h2>
<p>takes 4mn</p>
<h2>STEP 014 (mode = 1): Tune Lyot stops conjugations</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7615 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.6991 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    193287.4013 0.464428</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       176.5218 0.000424</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7       176.5218 0.000424</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 2220.58 -&gt; 1.28202e-08</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 147416, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 3.49379e-10</div>
</div><!-- fragment --><p>Takes 12mn</p>
<h2>STEP 015 (mode = 40): tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;    FLUX   0    416183.9306 1.000000</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    FLUX   1    416183.9306 1.000000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    FLUX   2    416183.8669 1.000000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    FLUX   3    416183.7606 1.000000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    FLUX   4    416183.6984 0.999999</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    FLUX   5    194898.6729 0.468299</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    FLUX   6       176.7694 0.000425</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    FLUX   7       176.7694 0.000425</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Peak constrast (rough estimate)= 1145.55 -&gt; 6.6137e-09</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;optsyst[0].flux[0]  = 416184</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;SCORINGMASKTYPE = 0</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[0] Total light in scoring field = 86266.2, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 2.04453e-10</div>
</div><!-- fragment --><p>Takes 1.5hr</p>
<h2>STEP 016 (mode = 40): tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</h2>
<p>In this example step 17 is skipped by typing:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;touch piaacmcconf_i000/step016.txt</div>
</div><!-- fragment --><h2>STEP 017 (mode = 40): tune PIAA shapes and focal plane mask transm, 40 cosine modes, 625 Fourier modes</h2>
<p>In this example step 17 is skipped by typing:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;touch piaacmcconf_i000/step017.txt</div>
</div><!-- fragment --><h1>Design steps: Polychromatic design</h1>
<h2>Compute complex amplitude response of each focal plane mask zone</h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./run optsingle 200</div>
</div><!-- fragment --><p>This command will run for a few hrs if the number of focal plane mask zones is large.</p>
<p>The complex amplitude response of each mask zone is computed. Several sub-processes are launched, each computing a subset of the total number of zones.</p>
<p>You can follow the progress of each subprocess in the corresponding tmux sessions: the tmux session names are PID followed by FPMt&lt;index&gt;n&lt;NBindex&gt;</p>
<p>As each subprocess computes zone responses, they are stored in FITS files FPMresp..._thread&lt;index&gt;.fits.tmp you can open/view these files to follow progress - each zone appears as a line, and files should fill from the bottom to the top when all threads complete, the files are merged into a single FPMresp file.</p>
<h2>Search for optimal solution</h2>
<p>Once the FPMresp... file is created, it is used by the search algorithm to quickly evaluate focal plane mask designs.</p>
<p>The search algorithm proceeds as two nested loops (outer loop steps 1-4, inner loop steps 2-4):</p>
<ol type="1">
<li>OUTER LOOP START ITERATION: starting point is chosen, either randomly or close to the best solution.</li>
<li>INNER LOOP START ITERATION: Derivatives around the current point.</li>
<li>For each predefined regularization coefficient : a. An SVD-based inversion used to define a search direction b. The solution is evaluated along the search direction, and the best point along this line is recorded</li>
<li>The best solution encountered in the above step is recorded. If it is a significant improvement over the last step 3 iteration, goto step 2, if not, go to step 1. If the inner loop (steps 2-3) has been running for more than 50 iterations, go to step 1.</li>
</ol>
<p>In the C code, this optimization corresponds to execution mode 13. To stop the loop, create file "stoploop13.txt" in the working optimization directory: </p><pre class="fragment">touch piaacmcconf_i000/stoploop13.txt
</pre><p>Note that this command will stop the loop on entering step 1, so the inner loop (steps 2-4) will still keep running until the solution stops improving.</p>
<h1>C code description</h1>
<h2>PIAACMC_designcodes</h2>
<p>The main function in the source code is <a class="el" href="PIAACMCsimul_8c.html#a0b00332b096e51006fb9240491faf744" title="Main simulation routine. ">PIAACMCsimul_exec()</a>, which takes two arguments: the configuration index (usually a 3 digit integer) and the mode (integer) which describes the operation to be performed to the PIAACMC design.</p>
<hr/>
<p> Mode Description </p><hr/>
<p> 0 Compute on-axis propagation for specified configuration. If configuration does not exist, create idealized monochromatic PIAACMC (intended to create a new index) and compute on-axis propagation</p>
<p>1 Optimize Lyot stop(s) locations (scan)</p>
<p>2 Optimize focal plane mask transmission for idealized monochromatic PIAACMC (scan)</p>
<p>3 Run without focal plane mask (for testing and calibration)</p>
<p>4 Linear optimization around current design, free parameters = PIAA optics cosines shapes (track progress by looking at val.opt file)</p>
<p>5 Optimize Lyot stops shapes and positions</p>
<p>10 Setup polychromatic optimization</p>
<p>11 Compute polychromatic response to zones, store result in FPMresp</p>
<p>12 Search for best mask solution using FPMresp, random search</p>
<p>13 Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</p>
<p>40 Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</p>
<p>41 Optimize PIAA optics shapes and focal plane mask zones (polychromatic)</p>
<p>100 Evaluate current design: polychromatic contrast, pointing sensitivity</p>
<p>101 Transmission as a function of angular separation</p>
<p>200 Make focal plane mask OPD map </p><hr/>
<p>The following variables can be set :</p>
<hr/>
<p> Variable Description </p><hr/>
<p> PIAACMC_size Array size (1024, 2048, etc...)</p>
<p>PIAACMC_pixscale Pixel scale [m]</p>
<p>PIAACMC_dftgrid Sampling interval in DFTs</p>
<p>PIAACMC_centobs0 Input central obstruction</p>
<p>PIAACMC_centobs1 Output central obstruction</p>
<p>PIAACMC_nblambda Number of wavelength points</p>
<p>PIAACMC_resolved 1 if resolved source (3 points at r = 0.01 l/D, 120 deg apart)</p>
<p>PIAACMC_fpmtype 1 if physical mask, 0 if idealized mask</p>
<p>PIAACMC_FPMsectors Number of sectors in focal plane mask</p>
<p>PIAACMC_NBrings Number of rings in focal plane mask</p>
<p>PIAACMC_fpmradld Focal plane mask outer radius </p><hr/>
<h1>Initialization rules (function PIAAsimul_initpiaacmc() )</h1>
<ul>
<li>if configuration directory exists, use it and load configuration file ( function PIAAsimul_loadpiaacmcconf ), otherwise, create it</li>
<li>load/create Cmodes</li>
<li>load/create Fmodes</li>
<li>load mode coefficients for piaa shapes if they exist. If not:<ul>
<li>create radial apodization for centrally obscured idealized monochromatic PIAACMC</li>
<li>fit / extrapolate radial apodization profile with cosines</li>
<li>using above fit, create 2D radial sag for both PIAA optics ( -&gt; PIAA_Mshapes.txt)</li>
<li>make 2D sag maps for both optics ( -&gt; piaa0z.fits, piaa1z.fits)</li>
<li>fit 2D sag maps with Cmodes and Fmodes coefficients ( -&gt; piaa0Cmodes, piaa0Fmodes, piaa1Cmodes, piaa1Fmodes )</li>
</ul>
</li>
<li>load/create focal plane mask zone map. This is the map that defines the geometry (which ring is where)</li>
<li>load/create focal plane mask thickness array</li>
<li>load/create focal plane mask transmission array</li>
<li>load/create Lyot stops</li>
</ul>
<h3>Code breakdown</h3>
<ul>
<li><a class="el" href="PIAACMCsimul_8c.html#a0b00332b096e51006fb9240491faf744" title="Main simulation routine. ">PIAACMCsimul_exec()</a> :<ul>
<li><a class="el" href="PIAACMCsimul_8c.html#a85f1459cf776292b7e2fff9932a79252" title="Creates/initializes piaacmcconf structure and directory. ">PIAAsimul_initpiaacmcconf()</a>: Load/Creates/initializes piaacmcconf structure and directory<ul>
<li>perform default initialization</li>
<li><a class="el" href="PIAACMCsimul_8c.html#a029d653eddbea9d926a6ced9390e6289" title="Load configuration. ">PIAAsimul_loadpiaacmcconf()</a>: Loading PIAACMC configuration from "piaacmcconfxxx/piaacmcparams.conf" if it exists</li>
<li>Creating/loading Cmodes and Fmodes</li>
<li>IMPORT / CREATE PIAA SHAPES<ul>
<li>create 2D prolate iteratively</li>
<li><a class="el" href="PIAACMCsimul_8c.html#a0871e75df183df80cf726eb6593cd7b4">PIAACMCsimul_load2DRadialApodization()</a>:fit PIAA shapes with Cosine modes</li>
<li><a class="el" href="PIAACMCsimul_8c.html#af0a83785124bcdb0096fc0e831965b4e">PIAACMCsimul_init_geomPIAA_rad()</a>: compute radial PIAA sag from cosine apodization fit</li>
<li><a class="el" href="PIAACMCsimul_8c.html#a27cdd1e7d226e0e0120706737460e388">PIAACMCsimul_mkPIAAMshapes_from_RadSag()</a>: Make 2D sag shapes from radial PIAA sag</li>
</ul>
</li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS</li>
<li><a class="el" href="PIAACMCsimul_8c.html#afad859109ca486d90a908bcec11868f3" title="Save configuration. ">PIAAsimul_savepiaacmcconf()</a>: save configuration</li>
</ul>
</li>
<li><a class="el" href="PIAACMCsimul_8c.html#a0ae7439a20fe5267506bc7d1e0533f08">PIAACMCsimul_makePIAAshapes()</a>: construct PIAA shapes from fitting coefficients<ul>
<li>construct 2D PIAA mirror shapes from piaa0Cmodescoeff, piaa0Fmodescoeff, piaa1Cmodescoeff, piaa1Fmodescoeff</li>
</ul>
</li>
<li><a class="el" href="PIAACMCsimul_8c.html#a0650545f10bc1e359093510f12a9f9f6">PIAACMCsimul_computePSF()</a>: Compute PSF</li>
</ul>
</li>
</ul>
<h3>Output Files</h3>
<p>APLCmaskCtransm.txt ?? fpm_ampl.fits fpm_pha.fits FPmask.tmp.fits</p>
<h4>Configuration :</h4>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>./piaaconfxxx/piaacmcparams.conf </td><td>Configuration parameters </td></tr>
<tr>
<td>./piaaconfxxx/conjugations.txt </td><td>Conjugations </td></tr>
<tr>
<td>./piaaconfxxx/lambdalist.txt </td><td>list of wavelength values </td></tr>
<tr>
<td>./piaaconfxxx/pupa0_[size].fits </td><td>input pupil (created by default if does not exist) </td></tr>
</table>
<h4>Wavefront Modes :</h4>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>Cmodes.fits </td><td>circular radial cosine modes (40 modes, hard coded) </td></tr>
<tr>
<td>Fmodes.fits </td><td>Fourier modes (625 modes = 10 CPA, hard coded) </td></tr>
<tr>
<td>./piaaconfxxx/ModesExpr_CPA.txt </td><td>modes definition </td></tr>
<tr>
<td>./piaaconfxxx/APOmodesCos.fits </td><td>Cosine modes for fitting 2D apodization profile </td></tr>
</table>
<h4>PIAA mirrors, apodization, fits:</h4>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>./piaaconfxxx/APLCapo.1.400.0.300.info </td><td>file written by prolate generation function coronagraph_make_2Dprolate in <a class="el" href="coronagraphs_8c.html">coronagraphs.c</a> </td></tr>
<tr>
<td>./piaaconfxxx/apo2Drad.fits </td><td>idealized PIAACMC 2D apodization </td></tr>
<tr>
<td>./piaaconfxxx/piaam0z.fits </td><td>PIAA M0 shape (2D sag) </td></tr>
<tr>
<td>./piaaconfxxx/piaam1z.fits </td><td>PIAA M1 shape (2D sag) </td></tr>
<tr>
<td>./piaaconfxxx/PIAA_Mshapes.txt </td><td>PIAA shapes (radial txt file, cols: r0, z0, r1, z1) </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Fz.fits </td><td>PIAA M0 shape, Fourier components (2D file) </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Fz.fits </td><td>PIAA M1 shape, Fourier components (2D file) </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Cmodes.fits </td><td>idealized PIAACMC mirror 0 cosine modes (copied from ./piaaref/) </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Fmodes.fits </td><td>idealized PIAACMC mirror 0 Fourier modes (copied from ./piaaref/) </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Cmodes.fits </td><td>idealized PIAACMC mirror 1 cosine modes (copied from ./piaaref/) </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Fmodes.fits </td><td>idealized PIAACMC mirror 1 Fourier modes (copied from ./piaaref/) </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Cres.fits </td><td>idealized PIAA M0 cosine fit residual </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Cres.fits </td><td>idealized PIAA M1 cosine fit residual </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Cz.fits </td><td>idealized PIAA M0 cosine fit sag </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Cz.fits </td><td>idealized PIAA M1 cosine fit sag </td></tr>
<tr>
<td>./piaaconfxxx/piaa0Fz.fits </td><td>idealized PIAA M0 Fourier fit sag </td></tr>
<tr>
<td>./piaaconfxxx/piaa1Fz.fits </td><td>idealized PIAA M1 Fourier fit sag </td></tr>
</table>
<h4>Idealized PIAACMC reference point:</h4>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>./piaaconfxxx/piaaref/APLCmaskCtransm.txt </td><td>idealized PIAACMC focal plane mask transmission </td></tr>
<tr>
<td>./piaaconfxxx/piaaref/apo2Drad.fits </td><td>idealized PIAACMC output apodization </td></tr>
<tr>
<td>./piaaconfxxx/piaaref/piaa0Cmodes.fits </td><td>idealized PIAACMC mirror 0 cosine modes </td></tr>
<tr>
<td>./piaaconfxxx/piaaref/piaa0Fmodes.fits </td><td>idealized PIAACMC mirror 0 Fourier modes </td></tr>
<tr>
<td>./piaaconfxxx/piaaref/piaa1Cmodes.fits </td><td>idealized PIAACMC mirror 1 cosine modes </td></tr>
<tr>
<td>./piaaconfxxx/piaaref/piaa1Fmodes.fits </td><td>idealized PIAACMC mirror 1 Fourier modes </td></tr>
</table>
<h4>Focal plane mask:</h4>
<p>Focal plane mask design defined by :</p><ul>
<li>[s] Sectors flag (0: no sectors, 1: sectors), variable PIAACMC_FPMsectors</li>
<li>[r] Resolved target flag (0: point source, 1: resolved source)</li>
<li>[mr] Mask radius in units of 0.1 l/D</li>
<li>[rrr] number of rings, variable piaacmc[0].NBrings</li>
<li>[zzz] number of zones</li>
</ul>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>fpmzmap[s]_[rrr]_[zzz].fits </td><td>Zones map </td></tr>
<tr>
<td>fpm_zonea[r][s]_[mr]_[rrr]_[zzz].fits </td><td>amplitude for each zone </td></tr>
<tr>
<td>fpm_zonea[r][s]_[mr]_[rrr]_[zzz].fits </td><td>thickness for each zone </td></tr>
</table>
<p>IDEALIZED OR PHYSICAL MASK<br />
 Idealized mask is a single zone mask with thickness adjusted for lambda/2 phase shift and a (non-physical) partial transmission. Physical mask consist of 1 or more zones with full transmission. Each zone can have a different thickness.</p>
<p>By default, a non-physical mask is first created with transmission piaacmc[0].fpmaskamptransm read from piaacmcparams.conf. Computations indices using a physical mask:</p><ul>
<li>set transmission to 1.0: piaacmc[0].fpmaskamptransm = 1.0.</li>
<li>set focal plane mask radius to larger value: piaacmc[0].fpmRad = 0.5*(LAMBDASTART+LAMBDAEND)*piaacmc[0].Fratio * PIAACMC_MASKRADLD</li>
</ul>
<h4>Lyot stops:</h4>
<table class="doxtable">
<tr>
<th>Output file </th><th>Notes  </th></tr>
<tr>
<td>./piaaconfxxx/LyotStop0.fits </td><td>Lyot Stop 0 </td></tr>
<tr>
<td>./piaaconfxxx/LyotStop1.fits </td><td>Lyot Stop 1 </td></tr>
</table>
<h4>Amplitude &amp; Phase at planes:</h4>
<p>Files are /piaaconfxxx/WFamp_nnn.fits and WFpha_nnn.fits, where nnn is the plane index.<br />
Complex amplitude is shown AFTER the element has been applied, in the plane of the element.<br />
 </p><table class="doxtable">
<tr>
<th>Plane index </th><th>description  </th></tr>
<tr>
<td>000 </td><td>Input pupil </td></tr>
<tr>
<td>001 </td><td>Fold mirror used to induce pointing offsets </td></tr>
<tr>
<td>002 </td><td>PIAA M0 </td></tr>
<tr>
<td>003 </td><td>PIAA M1 </td></tr>
<tr>
<td>004 </td><td>PIAAM1 edge opaque mask </td></tr>
<tr>
<td>005 </td><td>post-focal plane mask pupil </td></tr>
<tr>
<td>006 </td><td>Lyot Stop 0 </td></tr>
<tr>
<td>007 </td><td>Lyot Stop 1 </td></tr>
<tr>
<td>008 </td><td>invPIAA1 </td></tr>
<tr>
<td>009 </td><td>invPIAA0 </td></tr>
<tr>
<td>010 </td><td>back end mask </td></tr>
</table>
<h4>Performance Evaluation:</h4>
<table class="doxtable">
<tr>
<th>Plane index </th><th>description  </th></tr>
<tr>
<td>./piaaconfxxx/scoringmask0.fits </td><td>Evaluation points in focal plane, hardcoded in <a class="el" href="PIAACMCsimul_8c.html#a0650545f10bc1e359093510f12a9f9f6">PIAACMCsimul_computePSF()</a> </td></tr>
<tr>
<td>./piaaconfxxx/CnormFactor.txt </td><td>PSF normalization factor used to compute contrast </td></tr>
<tr>
<td>./piaaconfxxx/flux.txt </td><td>total intensity at each plane </td></tr>
</table>
<h1>Low-level C code</h1>
<h2>Key functions</h2>
<p>Every time a PSF is computed, the following 3 functions are created in that order:</p>
<ul>
<li><code>PIAAsimul_initpiaacmcconf</code><ul>
<li>initialize piaacmc</li>
<li>create modes for aspheric optical surfaces description</li>
<li>CREATE DMs (Cmodes and Fmodes)</li>
<li>IMPORT / CREATE PIAA SHAPES</li>
<li>if does not exist: Creating 2D apodization for idealized circular monochromatic PIAACMC</li>
<li>compute radial PIAA sag, make 2D sag maps</li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS (LOADING/CREATING LYOT MASK)</li>
</ul>
</li>
<li><code>PIAACMCsimul_init(piaacmc, 0, xld, yld)</code> : initializes optical system to piaacmc design</li>
<li><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code> : create 2D PIAA shapes (<code>piaam0z</code> and <code>piaam1z</code>) from coefficient values and modes</li>
<li><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code> : perform optical propagation</li>
</ul>
<p>Note that the last 3 functions are wrapped togeter in the computePSF function, which allows multi-point (extended sources) :</p>
<ul>
<li><code><a class="el" href="PIAACMCsimul_8h.html#a0650545f10bc1e359093510f12a9f9f6">PIAACMCsimul_computePSF(float xld, float yld, long startelem, long endelem, int savepsf, int sourcesize, int extmode, int outsave)</a></code> : compute PSF<ul>
<li><code>PIAACMCsimul_init(piaacmc, 0, xld+rad1, yld)</code></li>
<li><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code></li>
<li><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code></li>
</ul>
</li>
</ul>
<h2>Full PIAACMC design in monochromatic light</h2>
<p>The first step of the optimization process is to compute the PIAACMC optics and focal plane mask in the idealized case: monochromatic light, point source, and ideal focal plane mask (circular, phase-shifting and partially transmissive). Steps are shown in the figure below and correspond to steps in the <code>runPIAACMC</code> state machine.</p>
<div class="image">
<img src="figures/runPIAACMCsteps.jpg"  alt="PIAACMC design steps"/>
</div>
<h2>APLC design</h2>
<p>The scripts produce an APLC design by setting <code>PIAAmode = 0</code>. In that case, only <code>step000</code> in the figure above is executed.</p>
<h2>Focal plane mask optimization</h2>
<h3>Overall flow</h3>
<p>FPM optimization is done as <code>mode = 13</code> in the main routine. It is called from the <code>runPIAACMC</code> script. The <code>PIAACMCsimul_run(char *confindex, long mode)</code> function loop-calls the <code>PIAACMCsimul_exec(char *confindex, long mode)</code> function with mode 13 until search time is reached.</p>
<p>Each search proceeds as follows :</p>
<ul>
<li>a starting point is picked. A random integer <code>zeroST</code> encodes the starting poing:<ul>
<li>0:</li>
<li>1: start at zero</li>
<li>2: start at best solution</li>
</ul>
</li>
<li>run <code>PIAACMCsimul_exec</code> in mode 13<ul>
<li>randomly move next to starting point</li>
<li>compute value and store it to valref variable</li>
<li>enter gradient search loop<ul>
<li>compute local derivatives</li>
<li>compute SVD of Jacobian matrix to identify vectors of steepest descent</li>
<li>for each alphareg = 0, 0.25, 0.5, 0.75, 1.0:<ul>
<li>do a linescan descent along the vector identified by SVD, with the alphareg regularization coefficient</li>
<li>the best value is stored as <code>bestval</code> and the corresponding parameters into <code>data.image[IDoptvec].array.F[i]</code></li>
<li>store best values in <code>PIAACMCSIMUL_VAL</code>, and reference value in <code>PIAACMCSIMUL_VALREF</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>computePSF_FAST_FPMresp = 1</code> : uses pre-computed complex amplitude zones response to evaluate FPM solutions</li>
<li><code>PIAACMC_FPM_FASTDERIVATIVES = 1</code></li>
</ul>
<p>To stop the optimization and have the current best solution adopted, enter a small value in the <code>searchtime.txt</code> file, so that the optimization process completes.</p>
<h3>Regularization</h3>
<p>There are two regularization:</p>
<ul>
<li>Focal plane mask zone sags can be included in the linear optimization as extra components to the optimization vector</li>
<li>PIAA shapes coefficients are simply added to the evaluation metric</li>
</ul>
<h3>Key files</h3>
<ul>
<li><code>fpm_zonez_.....best.fits</code> is the optimal solution</li>
<li><code>mode13_....bestval.txt</code> is the corresponding value</li>
</ul>
<p>To restart the optimization from scratch, remove these two files.</p>
<p>Average contrast = 5.964e-05 0.001 -&gt; Average contrast = 8.57575e-07, 1.9e-7 0.01 -&gt; Average contrast = 7.99085e-07, 2.0e-7 7.8294e-07 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jul 29 2017 09:47:59 for cfitsTK by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
